<% content_for :head do %>
   <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
   <%= javascript_include_tag "http://maps.google.com/maps/api/js?sensor=false"  %>
   <%= javascript_include_tag "jquery.gmap.min"  %>
   <%= javascript_include_tag "styled_marker"  %>
   <%= javascript_include_tag "map.min"  %>
   <%= javascript_include_tag "jquery-ui-1.8.13.custom.min"  %>
   <%= javascript_include_tag "map.markerwithlabel"  %>
   <%= stylesheet_link_tag "jquery-ui-1.8.13.custom"  %>
   <script type="text/javascript">
    
    $(function(){
        loading("#map_canvas");
        MD.createMap("#map_canvas");
        //renderPushPin(places,clouds);

        $("#slide_min").html ( MD.date.getDateAfter(60) );
        $("#slide_selected").html( MD.date.getDateAfter(0)  );
        $("#slide_max").html ( MD.date.getDateAfter(0) );


        MD.visualize.create();
        
        buildActionType();
        buildCalendar();
        showClick();

        MD.bcUI.create("#breakcrump");
        getPushPins(<%= (@country.parent_id.nil?)?0:@country.parent_id %>)
        loading("#map_canvas");
        
     });

     function buildBCElement(){
       var bcElement = $(".bcElement");
       bcElement.unbind();
       bcElement.click(function(){
         getPushPins(this.rel);
         return false;
       })
     }

     function showClick(){
       $("#show_report").click(function(){
          var id = $("#place_id").val();
          getPushPins(id);
          return false;
       });
     }

     function buildCalendar(){
       $(".calendar").datepicker({
         dateFormat : "yy-mm-dd",
         changeYear : true,
         changeMonth: true
       });
     }

     function buildActionType(){
       $("input[name=time][type=radio]").click(function(){
         
         MD.visualize.updateType(this.value);
       })
     }

     function renderPushPin(result){
       MD.removeMarkers();
       
       var places = result["place"];
       var clouds = result["cloud"];

       for(var i=0; i< places.length; i++){
           options = {
                          lat : places[i]["lat"] ,
                          lng:  places[i]["lng"] ,
                          title: places[i]["name"]+": " + places[i]["total"] ,
                          icon : "<%= root_url  %>images/pushpins/" + clouds[places[i].name].size + ".png",
                          place_id : places[i]["id"]
                        }
           var marker = MD.createMarker(options);
           //var marker = MD.createStyledMarker(options);
           
           MD.createEvent(marker, 'dblclick', function(){
             getPushPins(this.place_id);
           });

           MD.createEvent(marker,'click', function(){
              MD.activeMarker = this;
              getListReport(this.place_id);
           });
        }

        if(typeof result["parent"] != "undefined")
          $("#place_id").val(result["parent"].paren_id);
        
        if(places.length >1)
          MD.boundBox();
        else{
          console.dir(places);
          MD.centerTo(places[0]["lat"], places[0]["lng"]);
        }
        /*
        var zoom = MD.map.getZoom();
        
        var center = MD.map.getCenter();
        setTimeout(function(){
          MD.map.setZoom(zoom);
          MD.map.setCenter(center);
        }, 1000);
        */
        

     }

     function loading(container){
       var map = $(container);
       var loading = $("#ajax_loading")
       var pos =  map.offset();

       var loading_width = loading.width();
       var loading_height= loading.height();

       var width = map.width();
       var height = map.height();
       
       var top = pos.top + (height/2) -(loading_height/2) + "px" ;
       var left = pos.left + (width/2) -(loading_width/2) + "px" ;

       $("#ajax_loading").css("left",left);
       $("#ajax_loading").css("top",top);

     }

     function getListReport(id){
       $("#ajax_loading").show();
       MD.date.toCalender(); 
       var from = $("#from").val();
       var to = $("#to").val();
       var url = "<%= map_visualizations_url %>"
       $.ajax({
         url:url,
         cache : false,
         data : {"from": from, "to" : to,"id":id},
         success: handleListReport
       });
     }

     function getListReportByItem(url){
       $("#ajax_loading").show();
       $.ajax({
         url:url,
         cache : false,
         success: handleListReport
       });
     }
     
     function handleListReport(result, status, responseObj){
         $("#ajax_loading").hide();
         var info = MD.getInfoWindow();
         info.setContent(result);
         info.open(MD.map,MD.activeMarker);
         buildPaginatorItemClick();
     }

     function buildPaginatorItemClick(){
       var items =$("div.pagination>a");
       items.unbind();
       items.click(function(){
          var url = this.href ;
          getListReportByItem(url);
          return false;
       });
     }


     function getPushPins(id){
       $("#ajax_loading").show();
       MD.date.toCalender(); 
       var from = $("#from").val();
       var to = $("#to").val();
       
       var url = "<%= map_report_map_visualizations_url %>.json"
       $.ajax({
         url:url,
         dataType: "json",
         cache : false,
         data : {"from": from, "to" : to,"id":id},
         success: function(result, status, responseObj){
  
           $("#ajax_loading").hide();
           renderPushPin(result);
           
           if(typeof result["parent"] !="undefined"){
            MD.bcUI.setAsObj(result["parent"]);
            MD.bcUI.show(result["parent"]["type"]);
           }
           buildBCElement();
         }
         
       });
       return false;
     }







   </script>
 <% end %>
 <div >
   <div id="breakcrump"> 
     <span class="bcElement" ></span>
   </div>
 </div>

 <div id="ajax_loading" class="loading round" >Waiting for server response</div>
 <div id="map_canvas">Your browser doesn't support map</div>
 <input type="hidden" id="place_id" name="place_id" value="0" />
 <br />
 <div id="slide_status" ></div>
 <div class="slidePanel round">
    <div id="slider" ></div>
    <div class="slide_label" >
      
      <div style="float:left;width: 200px;">  <span class="round" id="slide_min" > </span></div>
      <div style="float:right;width: 200px;text-align:right;">  <span class="round" id="slide_max" > </span></div>
      <div style="float:left;width: 200px;margin-left: 245px;"> <span class="round" id="slide_selected" > </span></div>
      <div class="clear" >&nbsp;</div>
    </div>

    <div class="slide_control">
      <div class="slideOption" >
          <span class="round">
            <input type="radio" name="time" value="day" id="day" checked />
            <label for="day" > Day </label>
          </span>
      </div>
      <div class="slideOption" >
          <span class="round"><input type="radio" name="time"  value="week" id="week" /> 
            <label for="week" > Week </label>
          </span>
      </div>
      <div class="slideOption" >
         <span class="round"> <input type="radio" name="time"  value="month" id="month" />
           <label for="month" > Month </label>
         </span>
      </div>
      <div class="slideOption" >
        <span class="round">
          <input type="radio"  name="time" value="year" id="year" />
          <label for="year" > Year </label>
        </span>
      </div>

      <div class="slideOption" >
        <span class="round">
          <input type="radio"  name="time" value="custom" id="custom" />
          <label for="custom" > Custom </label>
        </span>
      </div>
      
      <div id="customOption" class="round" >
        
        <div class="slideOption" >
          <span class="round">
            <label for="custom" > From </label> <br />
            <input type="text" class="calendar round" name="time" value="" id="from" name="from" />     
          </span>
        </div>

        <div class="slideOption" >
          <span class="round">
            <label for="custom" > To </label> <br />
            <input type="text"  class="calendar round" name="time" value="" id="to" name="to" />
          </span>
        </div>
      </div>

      <div class="clear" >&nbsp;</div>
    </div>
    <div style="margin-top:10px;">
        <%= button_to "Show",  {:method =>"get"},:id=>"show_report" %>
    </div>

 </div>


