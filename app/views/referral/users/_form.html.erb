<% url = @user.new_record? ? referral_users_path : referral_user_path(@user) %>
<%=render_errors_for @user %>

<%=form_for @user, :url => url, :id=> :form_user do |form| %>
  <%=tag_row do %>
	<%= form.label :user_name %>
	<%= form.text_field :user_name %>
  <%end%>	

<%=tag_row do %>
	<%= form.label :email %>
	<%= form.email_field :email %>
  <%end%>	

<%=tag_row do %>
	<%= form.label :phone_number %>
	<%= form.text_field :phone_number %>
  <%end%>	

<% if @user.new_record? %>
  <%=tag_row do %>
  	<%= form.label :password %>
  	<%= form.password_field :password %>
    <%end%>	

  <%=tag_row do %>
  	<%= form.label :password_confirmation %>
  	<%= form.password_field :password_confirmation %>
    <%end%>
<% end %>  

<%=tag_row do %>
	<%= form.label :role %>
	<%= form.select :role, User::Roles_Ref.map {|role| [role, role]}, { :include_blank => "Select role"} %>
<%end%>
<div id="ref_place_active">
  
</div>
  <%
    od_hide = @user.role == User::ROLE_REF_PROVIDER ? "" : "c-hidden"
    hc_hide = @user.role == User::ROLE_REF_HC ? "" : "c-hidden"
  %>
  <%=tag_row :id => "ref_od", :class=> "#{od_hide}" do %>
          <%= form.label :intended_place_code, "OD" %>
          <%= form.text_field :intended_place_code, :"data-provide" =>"typeahead", 
          :"data-source" => "#{OD.list}", :autocomplete => "off", :id => "ref_od_input" %>
    <%end%>	

  <%=tag_row :id=>"ref_hc", :class => "#{hc_hide}" do %>
          <%= form.label :intended_place_code, "Health Center" %>
          <%= form.text_field :intended_place_code, :"data-provide" =>"typeahead", 
          :"data-source" => "#{HealthCenter.list}", :autocomplete => "off", :id => "ref_hc_input" %>
    <%end%>

<%=tag_row do %>
	<%= form.label :status %>
	<%= form.select :status, User::Status.sort %>
<%end%>	  	


<%=tag_row do %>
  <%= form.label :apps_mask, "Application" %>
  <% User::APPS.each do |app| %>
    <%= tag_row  do%>
      <%= check_box_tag "user[apps][]", app, @user.apps.include?(app), :class => "user_checkbox_app" %>
      <%= app.humanize %>
    <% end %>
  <% end %>
  <%= hidden_field_tag "user[apps][]", "" %>
<% end %>

<%=tag_row do %>
	<%= form.label ""  %>
	<%= form.submit "Save", :class => "btn btn-primary" %>
  <%end%>  
<%end%>
<% content_for :js do %>
  <script >
    function hide(){
      $("#ref_hc, #ref_od").hide();
    }

    function handleEvent(){
      $("#user_role").change(function(){
        hide();
        if(this.selectedIndex ==1 )
           $("#ref_od").show()

        else if(this.selectedIndex == 2)
          $("#ref_hc").show();

    });


      
    $("form.edit_user, form.new_user").submit(function(){
         errors = validate();
         if(errors.length){
            alert(errors.join("\n"));
            return false;
         }

         var index = $("#user_role").get(0).selectedIndex;
         
         if(index == 1){
           $("#ref_hc").remove();
         }
         
         else if( index == 2){
           $("#ref_od").remove();
         }         
      });  
    }
    
    function validate(){
      var errors = []

      if(empty($("#user_user_name").val())){
        errors.push("Please enter User name");
      }
      <% if @user.new_record? %>
          if(empty ($("#user_password").val()) || empty($("#user_password_confirmation").val()) ) {
            errors.push("Please enter Password / Confirm password");
          }

          if($("#user_password").val() != $("#user_password_confirmation").val() ){
            errors.push("Password / Confirm password not matched ");
          }
      <% end %>
        
      /*  
      if(empty( $("#user_email").val())) {
        errors.push("Please enter Email");
      }
      */
      if(empty( $("#user_phone_number").val())) {
        errors.push("Please enter Phone number");
      }

      var index = $("#user_role").get(0).selectedIndex;
      if(index == 0){
        errors.push("Please select a role");
      }
 

      if(index== 1) {
        if($("#ref_od_input").val() == "")
          errors.push("Please select an OD ");
      }

      else if(index == 2) {
        if($("#ref_hc_input").val == "" )
          errors.push("Please select a Health center");
      }
      
      checkboxs = $(".user_checkbox_app");
      error = true;
      for(var i=0; i< checkboxs.length; i++){
         if(checkboxs.get(i).checked) {
            error = false;
            break;
         }
      }
      
      if(error){
        errors.push("Please check at least one application");
      }
      
      return errors;

    }
    
    function empty(str){
      if($.trim(str) == "")
        return true;
      return false; 
    }
    

    $(function(){
      handleEvent();
    });
  </script>
<% end %>